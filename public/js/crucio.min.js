angular.module("adminModule",[]).controller("adminCtrl",["$scope","Page","$http","Selection","$interval",function(a,b,c,d){b.set_title_and_nav("Verwaltung | Crucio","Admin"),a.user=angular.fromJson(sessionStorage.user),a.user_search={semester:"",group:"",login:"",query:"",query_keys:["group_name","username"]},a.comment_search={question_id:"",username:"",query:"",query_keys:["question","comment","username","question_id"]},a.update_activity=!1,a.show_activity={search_query:!1,result:!1,login:!1,register:!1,comment:!1,exam_new:!1,exam_update:!1},a.$watch("comment_search",function(b){a.questions_by_comment_display=[],a.questions_by_comment.forEach(function(c){for(var e=0;e<c.length;e++){var f=c[e];if(d.is_element_included(f,b)){for(var g=-1,h=0;h<a.questions_by_comment_display.length;h++)if(a.questions_by_comment_display[h][0].question==f.question){g=h;break}g>-1?a.questions_by_comment_display[g].push(f):a.questions_by_comment_display.push([f])}}}),a.questions_by_comment_display.sort(function(a,b){return b[0].date-a[0].date})},!0),c.get("api/v1/users").success(function(b){a.users=b.users,a.distinct_semesters=d.find_distinct(a.users,"semester"),a.distinct_semesters.sort(function(a,b){return a-b}),a.distinct_groups=["Standard","Admin","Autor"],a.ready=1}),c.get("api/v1/comments").success(function(b){a.comments=b.comments,a.distinct_questions=d.find_distinct(a.comments,"question_id"),a.distinct_users=d.find_distinct(a.comments,"username"),a.questions_by_comment=[],a.comments.forEach(function(b){for(var c=-1,d=0;d<a.questions_by_comment.length;d++)if(a.questions_by_comment[d][0].question==b.question){c=d;break}c>-1?a.questions_by_comment[c].push(b):a.questions_by_comment.push([b])}),a.questions_by_comment_display=a.questions_by_comment}),c.get("api/v1/whitelist").success(function(b){a.whitelist=b.whitelist}),c.get("api/v1/stats/general").success(function(b){a.stats=b.stats}),a.add_mail=function(){var b=a.new_whitelist_mail;if(b.length){a.whitelist.push({username:"",mail_address:b});var d={mail_address:b.replace("@","(@)")};c.post("api/v1/whitelist",d).success(function(){})}},a.remove_mail=function(b){var d=a.whitelist[b].mail_address;d.length&&(a.whitelist.splice(b,1),c["delete"]("api/v1/whitelist/"+d).success(function(){}))},a.send_mail=function(){var a="";$("#user-table tbody tr:visible").children("td").children("a").each(function(b,c){a+=$(c).attr("data-original-title")+","}),a=a.slice(0,-1),window.location.href="mailto:"+a},a.change_group=function(b){var d=a.users[b].user_id,e=a.users[b].group_id;if(1==d)return!1;2==e?(e=1,a.users[b].group_name="Standard"):3==e?(e=2,a.users[b].group_name="Admin"):(e=3,a.users[b].group_name="Autor");var f={group_id:e};a.users[b].group_id=e,c.put("api/v1/users/"+d+"/group",f).success(function(){})},a.is_today=function(a){var b=new Date,c=new Date(1e3*a);return b.toDateString()==c.toDateString()?!0:!1},a.is_yesterday=function(a){var b=new Date,c=b-864e5,d=new Date(c),e=new Date(1e3*a);return d.toDateString()==e.toDateString()?!0:!1},a.user_in_selection=function(b){return d.is_element_included(a.users[b],a.user_search)},a.user_in_selection_count=function(){return d.count(a.users,a.user_search)},a.comment_in_selection_count=function(){return d.count(a.comments,a.comment_search)},a.increase_semester=function(){var a={number:"1"};c.post("api/v1/admin/change-semester/dFt(45i$hBmk*I",a).success(function(a){alert(a.status)})},a.decrease_semester=function(){var a={number:"-1"};c.post("api/v1/admin/change-semester/dFt(45i$hBmk*I",a).success(function(a){alert(a.status)})},a.remove_test_account=function(){c["delete"]("api/v1/users/test-account").success(function(a){alert(a.status)})}}]),angular.module("authorModule",[]).controller("authorCtrl",["$scope","Page","$location","$http","Selection",function(a,b,c,d,e){b.set_title_and_nav("Autor | Crucio","Autor"),a.user=angular.fromJson(sessionStorage.user),a.subject_list=subject_list,a.exam_search={subject:"",semester:"",author:a.user.username,query:"",query_keys:["subject","author","date"]},a.comment_search={username_added:"",username:"",query:"",query_keys:["question","comment","username","question_id"]},a.$watch("comment_search",function(b){a.questions_by_comment_display=[],a.questions_by_comment.forEach(function(c){for(var d=0;d<c.length;d++){var f=c[d];if(e.is_element_included(f,b)){for(var g=-1,h=0;h<a.questions_by_comment_display.length;h++)if(a.questions_by_comment_display[h][0].question==f.question){g=h;break}g>-1?a.questions_by_comment_display[g].push(f):a.questions_by_comment_display.push([f])}}}),a.questions_by_comment_display.sort(function(a,b){return b[0].date-a[0].date})},!0),d.get("api/v1/exams/all-visibility").success(function(b){a.exams=b.exams,a.distinct_semesters=[],a.exams.forEach(function(b){-1==a.distinct_semesters.indexOf(b.semester)&&a.distinct_semesters.push(b.semester)}),a.distinct_semesters.sort(),a.distinct_subjects=[],a.exams.forEach(function(b){-1==a.distinct_subjects.indexOf(b.subject)&&a.distinct_subjects.push(b.subject)}),a.distinct_subjects.sort(),a.distinct_authors=[],a.exams.forEach(function(b){-1==a.distinct_authors.indexOf(b.author)&&a.distinct_authors.push(b.author)}),a.distinct_authors.sort(),a.ready=1}),d.get("api/v1/comments/author/"+a.user.user_id).success(function(b){a.comments=b.comments,a.distinct_users=[],a.distinct_users_added=[],a.distinct_users=e.find_distinct(a.comments,"username"),a.distinct_users_added=e.find_distinct(a.comments,"username_added"),a.questions_by_comment=[],a.comments.forEach(function(b){for(var c=-1,d=0;d<a.questions_by_comment.length;d++)if(a.questions_by_comment[d][0].question==b.question){c=d;break}c>0?a.questions_by_comment[c].push(b):a.questions_by_comment.push([b])}),a.questions_by_comment.sort(function(a,b){return b[0].date-a[0].date}),a.questions_by_comment_display=a.questions_by_comment,a.comment_search.username_added=a.user.username}),a.new_exam=function(){var b={subject:"",professor:"",semester:"",date:"",type:"",user_id_added:a.user.user_id,duration:"",notes:""};d.post("api/v1/exams",b).success(function(a){c.path("/edit-exam").search("id",a.exam_id)})},a.comment_in_selection=function(b){return e.is_element_included(a.comments[b],a.comment_search)},a.comment_in_selection_count=function(){return e.count(a.comments,a.comment_search)},a.exam_in_selection=function(b){return e.is_element_included(a.exams[b],a.exam_search)},a.exam_in_selection_count=function(){return e.count(a.exams,a.exam_search)}}]).controller("editCtrl",["$scope","$routeParams","Page","$location","$http","FileUploader",function(a,b,c,d,e,f){function g(){a.uploader_array=new Array;for(var b=0;b<a.exam.questions.length;b++){{var c=new f({url:"/public/php/upload-file.php",formData:b});a.exam.questions[b]}c.onSuccessItem=function(b,c){var d=b.formData;a.exam.questions[d].question_image_url=c.upload_name},a.uploader_array.push(c)}}function h(){var a=$(this).height()-300+i.height();a>k.height()&&(a=k.height()),j.height(a)}c.set_title_and_nav("Klausur | Crucio","Autor"),a.ready=0,a.user=angular.fromJson(sessionStorage.user),a.exam_id=b.id,a.open_question_id=b.question_id,a.subject_list=subject_list,a.has_changed=0,a.number_changed=0,a.is_saving=0,a.uploader=new f({url:"/public/php/upload-file.php"}),a.uploader.onSuccessItem=function(b,c){a.exam.file_name=c.upload_name},a.uploader_array=[];{var i=$("#footer"),j=$(".edit-exam-wrapper"),k=$(".edit-exam-wrapper .exam-edit-list-group");a.$watch("exam",function(){a.number_changed>1&&(a.has_changed=1),a.number_changed+=1},!0)}$("body").on("shown.bs.tab",'a[data-toggle="tab"]',function(a){var b=$(this).closest(".list-group").children(".active");b.removeClass("active"),$(a.target).addClass("active")}),a.$on("$locationChangeStart",function(b){if(1==a.has_changed){var c=confirm("Die Änderungen an deiner Klausur bleiben dann ungespeichert. Wirklich verlassen?");c||b.preventDefault()}}),$(window).on("resize",function(){h()}),e.get("api/v1/exams/"+a.exam_id).success(function(b){a.exam=b,a.exam.semester=parseInt(b.semester),a.exam.duration=parseInt(b.duration);for(var c=0;c<a.exam.questions.length;c++)0==a.exam.questions[c].topic.length&&(a.exam.questions[c].topic="Sonstiges");g(),0==a.exam.questions.length&&a.add_question(0,!1),a.exam.subject||(a.exam.subject="Allgemeine Pathologie",a.exam.sort="Erstklausur"),a.open_question_id,a.ready=1,setTimeout(function(){h()},10)}),a.add_question=function(b,c){"undefined"==typeof c&&(c=!0);var d={};if(d.question="",d.type=5,d.correct_answer=0,d.answers=new Array("","","","","",""),d.topic="Sonstiges",a.exam.questions.push(d),a.open_question_id=0,g(),setTimeout(function(){h()},10),c){var e=a.exam.questions.length+1;setTimeout(function(){$(".edit-exam-wrapper a:nth-child("+e+")").tab("show")},10)}},a.delete_question=function(b){var c=a.exam.questions[b].question_id;c&&e["delete"]("api/v1/questions/"+c).success(function(){}),a.exam.questions.splice(b,1),g();var d=b+1;setTimeout(function(){$(".edit-exam-wrapper a:nth-child("+d+")").tab("show")},10),0==a.exam.questions.length&&a.add_question(1),setTimeout(function(){h()},10)},a.leave_edit=function(){a.$apply(d.path(a.next_route))},a.save_exam=function(){var b=!0;if(a.exam.subject||(b=!1),a.exam.semester<1&&(b=!1),a.exam.date||(b=!1),b){a.is_saving=1;var c=a.exam;e.put("api/v1/exams/"+a.exam_id,c).success(function(){}),a.exam.questions.forEach(function(b){var c=!0;if(b.question.length||(c=!1),b.question_id&&(c=!0),c){!b.explanation,b.explanation="",b.question_image_url||(b.question_image_url="");var d={question:b.question,topic:b.topic,type:b.type,answers:b.answers,correct_answer:b.correct_answer,exam_id:a.exam.exam_id,user_id_added:a.user.user_id,explanation:b.explanation,question_image_url:b.question_image_url};b.question_id?e.put("api/v1/questions/"+b.question_id,d).success(function(){}):e.post("api/v1/questions",d).success(function(a){b.question_id=a.question_id,console.log(a)})}}),a.has_changed=0,a.is_saving=0}else alert("Da fehlen noch allgemeine Infos zur Klausur.")},a.delete_exam=function(){e["delete"]("api/v1/exams/"+a.exam.exam_id).success(function(){d.url("/author")})}}]);var base_url="http://www.crucio-leipzig.de",is_dev=7==base_url.indexOf("dev")?1:0,subject_list={"Anästhesie und Intensivmedizin":[],Biologie:[],Biochemie:["Chemie der Kohlenhydrate","Chemie der Aminosäuren, Peptide und Proteine","Chemie der Fettsäuren und Lipide","Chemie der Nukleotide und Nukleinsäuren","Vitamine und Koenzyme","Enzyme","Ernährung, Verdauung, Resorption","Abbau der Kohlenhydrate","Abbau der Fettsäuren, Ketonkörper","Aminosäurestoffwechsel","Zitratzyklus und Atmungskette","Glykogenstoffwechsel, Glukoneogenese","Biosynthese der Fettsäuren, Lipogenese","Mineral- und Elektrolythaushalt","Subzelluläre Strukturen","Nukleinsäuren, genetische Information, Molekularbiologie","Hormone","Immunchemie","Blut","Leber","Fettgewebe","Niere, Harn","Muskelgewebe, Bewegung","Binde- und Stützgewebe","Nervensystem"],Physik:[],Physiologie:["Allgemeine und Zellphysiologie, Zellerregung","Blut und Immunsystem","Herz","Blutkreislauf","Atmung","Arbeit- und Leistungsphysiologie","Ernährung, Verdauungstrakt, Leber","Energie- und Wärmehaushalt","Wasser- und Elektrolythaushalt, Nierenfunktion","Hormonale Regulationen","Sexualentwicklung und Reproduktionsphysiologie","Funktionsprinzipien des Nervensystems","Muskulatur","Vegetatives Nervensystem","Motorik","Somatoviszerale Sensorik","Visuelles System","Auditorisches System","Chemische Sinne","Integrative Leistungen des Zentralnervensystems"],Chemie:[],"Klinische Chemie":[],Histologie:[],"Gynäkologie":[],"Innere Medizin":[],Chirurgie:[],Pharmakologie:[],"Klinische Pharmakologie":[],Neuroanatomie:[],"Allgemeine Pathologie":[],"Mikrobiologie / Virologie / Immunologie / Hygiene":[],Psychologie:[],Anatomie:[],Allgemeinmedizin:[],Urologie:[],Dermatologie:[],Humangenetik:[],Neurologie:[],"Orthopädie":[],Psychiatrie:[]},crucioApp=angular.module("crucioApp",["ngRoute","ngSanitize","angular-loading-bar","ui.bootstrap","angularFileUpload","textAngular","angles","ipCookie","crucioModule","userModule","learnModule","authorModule","adminModule"]);crucioApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("",{templateUrl:"index.php",controller:"loginCtrl"}).when("/",{templateUrl:"index.php",controller:"loginCtrl"}).when("/forgot-password",{templateUrl:"forgot-password.php",controller:"forgotPasswordCtrl"}).when("/register",{templateUrl:"register.php",controller:"registerCtrl"}).when("/activate-account",{templateUrl:"activate-account.php",controller:"activateCtrl"}).when("/contact",{templateUrl:"contact.php",controller:"contactCtrl"}).when("/about",{templateUrl:"about.php",controller:"aboutCtrl"}).when("/blog",{templateUrl:"blog.php",controller:"blogCtrl"}).when("/stats",{templateUrl:"stats.php",controller:"blogCtrl"}).when("/questions",{templateUrl:"views/questions.html",controller:"questionsCtrl"}).when("/author",{templateUrl:"views/author.html",controller:"authorCtrl"}).when("/admin",{templateUrl:"views/admin.html",controller:"adminCtrl"}).when("/account",{templateUrl:"views/account.html",controller:"accountCtrl"}).when("/settings",{templateUrl:"views/settings.html",controller:"settingsCtrl"}).when("/edit-exam",{templateUrl:"views/edit-exam.html",controller:"editCtrl"}).when("/question",{templateUrl:"views/question.html",controller:"questionCtrl"}).when("/exam",{templateUrl:"views/exam.html",controller:"examCtrl"}).when("/statistics",{templateUrl:"views/statistics.html",controller:"statisticsCtrl"}).when("/exam-pdf",{templateUrl:"exam-pdf.php",controller:"examCtrl"}).when("/exam-solution-pdf",{templateUrl:"exam-solution-pdf.php",controller:"examCtrl"}).when("/analysis",{templateUrl:"views/analysis.html",controller:"analysisCtrl"}).when("/403",{templateUrl:"views/403.html",controller:"errorCtrl"}).when("/404",{templateUrl:"views/404.html",controller:"errorCtrl"}).when("/500",{templateUrl:"views/500.html",controller:"errorCtrl"}).otherwise({redirectTo:"/404"}),b.html5Mode(!0)}]),crucioApp.run(["ipCookie","$rootScope","$location",function(a,b,c){var d=["/","/contact","/about","/blog","/register","/activate-account","/forgot-password"],e=["/","/register","/forgot-password"],f=["/author","/edit-exam"],g=["/admin"];b.user=angular.fromJson(sessionStorage.user),b.is_dev=is_dev;var h=a("CrucioUserDev");b.user||h&&(b.user=h,sessionStorage.user=angular.toJson(h));var i=function(a){var b=a;return a.indexOf("?")>-1&&(b=a.substr(0,a.indexOf("?"))),d.indexOf(b)>-1?1:0},j=function(a){var b=a;return a.indexOf("?")>-1&&(b=a.substr(0,a.indexOf("?"))),e.indexOf(b)>-1?1:0},k=function(a){var b=a;return a.indexOf("?")>-1&&(b=a.substr(0,a.indexOf("?"))),f.indexOf(b)>-1?1:0},l=function(a){var b=a;return a.indexOf("?")>-1&&(b=a.substr(0,a.indexOf("?"))),g.indexOf(b)>-1?1:0};if(b.user)var m=b.user.group_id?1:0,n=3==b.user.group_id?1:0,o=2==b.user.group_id?1:0;else var m=0,n=0,o=0;!i(c.url())&&!m,j(c.url())&&m&&c.path("/403"),!k(c.url())||n||o||c.path("/403"),l(c.url())&&!o&&c.path("/403")}]),crucioApp.factory("Page",function(){var a="Crucio",b="";return{title:function(){return a},setTitle:function(b){a=b},nav:function(){return b},setNav:function(a){b=a},set_title_and_nav:function(c,d){a=c,b=d}}}),crucioApp.service("Selection",function(){this.is_element_included=function(a,b){for(var c in b)if("query"==c){var d="";b.query_keys.forEach(function(b){d+=a[b]+" "});for(var e=b.query.toLowerCase().split(" "),f=0,g=e.length;g>f;++f){var h=e[f];if(d.toLowerCase().indexOf(h)<0&&h)return!1}}else if("group"==c){if(b.group!=a.group_name&&b.group)return!1}else if("query_keys"!=c&&b[c]!=a[c]&&b[c])return!1;return!0},this.count=function(a,b){if(!a)return 0;for(var c=0,d=0;d<a.length;d++)this.is_element_included(a[d],b)&&c++;return c},this.find_distinct=function(a,b){var c=[];return a.forEach(function(a){-1==c.indexOf(a[b])&&c.push(a[b])}),c.sort(),c}}),crucioApp.filter("cut",function(){return function(a,b,c,d){if(!a)return"";if(c=parseInt(c,10),!c)return a;if(a.length<=c)return a;if(a=a.substr(0,c),b){var e=a.lastIndexOf(" ");-1!=e&&(a=a.substr(0,e))}return a+(d||" ?")}}),Array.prototype.getIndexBy=function(a,b){for(var c=0;c<this.length;c++)if(this[c][a]==b)return c},Array.prototype.getArrayByKey=function(a){for(var b=[],c=0;c<this.length;c++)this[c][a]&&b.push(this[c]);return b},angular.module("learnModule",[]).controller("questionsCtrl",["$scope","Page","$location","$http","Selection",function(a,b,c,d,e){b.set_title_and_nav("Lernen | Crucio","Lernen"),a.user=angular.fromJson(sessionStorage.user),a.user||window.location.replace(base_url),a.exam_search={subject:"",semester:"",query:"",query_keys:["subject","semester","date"]},a.comment_search={query:"",query_keys:["comment","username","question_id"]},a.tag_search={query:"",query_keys:["tag"]},a.subject_list=subject_list,a.question_field_message="",a.selection_subject_list={},a.selection_number_questions=0,a.number_questions_in_choosen_subjects=0,a.conditions=1;var f=new Spinner({length:0,radius:18,color:"#333",shadow:!1});$("#numberSlider").slider({value:a.selection_number_questions,step:10,min:0,max:a.number_questions_in_choosen_subjects}),a.$watch("selection_subject_list",function(){var b={ignoreLoadingBar:!0,selection_subject_list:a.selection_subject_list};d.post("api/v1/learn/number-questions",b).success(function(b){a.number_questions_in_choosen_subjects=b.number_questions,0==a.selection_number_questions&&(a.selection_number_questions=Math.min(a.number_questions_in_choosen_subjects,50)),a.selection_number_questions>a.number_questions_in_choosen_subjects&&(a.selection_number_questions=a.number_questions_in_choosen_subjects)})},!0),a.$watch("number_questions_in_choosen_subjects",function(){var b=a.number_questions_in_choosen_subjects;b>200&&(b=200);var c=10;100>b&&(c=10),40>b&&(c=4),20>b&&(c=1),200>b&&b%c!=0&&(b+=c),$("#numberSlider").slider({value:a.selection_number_questions,step:c,min:0,max:b})},!0),d.get("api/v1/exams/user_id/"+a.user.user_id).success(function(b){a.exams=b.exam,a.distinct_semesters=e.find_distinct(a.exams,"semester"),a.distinct_subjects=e.find_distinct(a.exams,"subject"),a.abstract_exams=[],a.exams.forEach(function(b){var c=!0;b.semester!=a.user.semester&&(c=!1),"unbekannt"==b.date&&(c=!1),a.exams.length>10&&b.question_count<30&&(c=!1),b.answered_questions>0&&(c=!0),c&&(b.answered_questions>0?a.abstract_exams.unshift(b):a.abstract_exams.push(b))}),a.ready=1}),d.get("api/v1/tags/"+a.user.user_id).success(function(b){a.tags=b.tags,a.distinct_tags=[],a.tags.forEach(function(b){b.tags.split(",").forEach(function(b){-1==a.distinct_tags.indexOf(b)&&a.distinct_tags.push(b)})}),a.questions_by_tag={},a.distinct_tags.forEach(function(b){a.questions_by_tag[b]=[]}),a.distinct_tags.forEach(function(b){a.tags.forEach(function(c){c.tags.split(",").forEach(function(d){b==d&&a.questions_by_tag[b].push(c)})})})}),d.get("api/v1/comments/"+a.user.user_id).success(function(b){a.comments=b.comments,a.questions_by_comment={},a.comments.forEach(function(b){a.questions_by_comment[b.question]=[]}),a.comments.forEach(function(b){a.questions_by_comment[b.question].push(b)})}),a.learn_exam=function(a){var b=1;d.get("api/v1/exams/action/prepare/"+a+"/"+b).success(function(b){var d={list:b.list};d.exam_id=a,sessionStorage.currentQuestionList=angular.toJson(d),c.path("/question").search("id",d.list[0].question_id)})},a.learn_subjects=function(){var b={selection_subject_list:a.selection_subject_list,selection_number_questions:a.selection_number_questions};d.post("api/v1/learn/prepare",b).success(function(a){console.log(a);var b={list:a.list};b.selection_subject_list=a.selection_subject_list,sessionStorage.currentQuestionList=angular.toJson(b),c.path("/question").search("id",b.list[0].question_id)})},a.reset_results=function(b){var c=a.exams[b].exam_id;a.exams[b].answered_questions=0;var e={};d["delete"]("api/v1/results/"+a.user.user_id+"/"+c,e).success(function(a){console.log(a)})},a.reset_abstract_results=function(b){var c=a.abstract_exams[b].exam_id;a.abstract_exams[b].answered_questions=0;var e={};d["delete"]("api/v1/results/"+a.user.user_id+"/"+c,e).success(function(){})},a.toggle_selection=function(b,c,d){var e=a.selection_subject_list,f=a.subject_list;if(d||(d=!1),Object.keys(e).indexOf(b)>-1)if(0==e[b].length)"all"==c&&delete e[b];else if(e[b].length>0)if("all"==c)d?delete e[b]:e[b]=f[b].slice(0);else{var g=e[b].indexOf(c);g>-1?(e[b].splice(g,1),0==e[b].length&&delete e[b]):e[b].push(c)}else e[b]="all"==c?f[b].slice(0):[c];else e[b]="all"==c?f[b].slice(0):[c]},a.search_question=function(){a.search_results=[];var b=a.question_search_query;if(a.question_field_message="",b.length){f.spin(document.getElementById("spinner"));{({query:b,subject:a.question_search_subject,semester:a.question_search_semester})}d.get("api/v1/questions/search/"+a.question_search_query+"/"+a.user.user_id).success(function(b){f.stop(),console.log(b),0==b.result.length?a.question_field_message="Nichts gefunden ;(":b.result.length>100?a.question_field_message="Zu Viel gefunden, geht es ein bisschen konkreter? ;(":a.search_results=b.result})}},a.exam_in_selection=function(b){return e.is_element_included(a.exams[b],a.exam_search)},a.exam_in_selection_count=function(){return e.count(a.exams,a.exam_search)},a.comment_in_selection=function(b){return e.is_element_included(a.comments[b],a.comment_search)},a.comment_in_selection_count=function(){return e.count(a.comments,a.comment_search)}}]).controller("examCtrl",["$scope","$rootScope","$routeParams","Page","$http","$location","$modal",function(a,b,c,d,e,f,g){d.set_title_and_nav("Klausur | Crucio","Lernen"),a.user=angular.fromJson(sessionStorage.user),a.exam_id=c.id,a.questionList={exam_id:a.exam_id,list:[]},a.Math=window.Math,a.current_index=0,e.get("api/v1/exams/"+a.exam_id).success(function(b){a.exam=b;var c=a.exam.questions;for(i=0;i<c.length;i++){var d=c[i];a.questionList.list[i]=d}}),a.save_answer=function(b,c){a.questionList.list[b].given_result=String(c)},a.scroll_to_top=function(){$(window).scrollTop(0)},a.hand_exam=function(){console.log("questionList Abgabe"),console.log(a.questionList),sessionStorage.currentQuestionList=angular.toJson(a.questionList),f.path("/analysis").search("id",null)},a.open_image_model=function(b){console.log("Current Index",a.current_index);g.open({templateUrl:"imageModalContent.html",controller:"ModalInstanceCtrl",resolve:{image_url:function(){return b}}})}}]).controller("questionCtrl",["$scope","Page","$routeParams","$http","$location","$modal",function(a,b,c,d,e,f){b.set_title_and_nav("Frage | Crucio","Lernen"),a.answerButtonClass="btn-primary",a.user=angular.fromJson(sessionStorage.user),a.questionList=angular.fromJson(sessionStorage.currentQuestionList),a.question_id=c.id,a.reset_session=c.reset_session,a.question_id||window.location.replace("/questions"),a.show_explanation=0,a.given_result=0,a.strike={},a.reset_session&&(a.questionList={},sessionStorage.currentQuestionList=angular.toJson(a.questionList)),a.questionList&&Object.keys(a.questionList).length&&(a.index=a.questionList.list.getIndexBy("question_id",a.question_id),a.length=a.questionList.list.length,a.show_answer=a.questionList.list[a.index].mark_answer,a.given_result=a.questionList.list[a.index].given_result,a.questionList.list[a.index].strike&&(a.strike=a.questionList.list[a.index].strike)),a.$watch("strike",function(b){a.questionList&&Object.keys(a.questionList).length&&(a.questionList.list[a.index].strike=b,sessionStorage.currentQuestionList=angular.toJson(a.questionList))},!0),d.get("api/v1/questions/"+a.question_id+"/user/"+a.user.user_id).success(function(b){a.question=b,a.question.question_image_url&&(a.question.question_image_url="/public/files/"+a.question.question_image_url);for(var c=0;c<a.question.comments.length;c++)a.question.comments[c].voting=parseInt(a.question.comments[c].voting)||0,a.question.comments[c].user_voting=parseInt(a.question.comments[c].user_voting)||0;var e=[];a.question.tags&&(e=a.question.tags.split(",")),$("#tagInput").tagsManager({prefilled:e,maxTags:5,replace:!0,output:null,tagsContainer:null,tagCloseIcon:"&times;",tagClass:"tm-tag-error",onlyTagList:!1,createHandler:function(b,c){var e={tags:c,question_id:a.question_id,user_id:a.user.user_id};d.post("api/v1/tags",e).success(function(){})},removeHandler:function(b,c){var e={tags:c,question_id:a.question_id,user_id:a.user.user_id};d.post("api/v1/tags",e).success(function(){})}}),a.given_result&&(console.log("question get given_result",a.given_result),a.check_answer(a.given_result)),a.show_answer&&a.mark_answer(a.given_result)}),a.show_solution=function(){var b=a.correct_answer(),c=b==a.given_result?1:0;0==b&&(c=-1),1==a.question.type&&(c=-1);var e={correct:c,question_id:a.question_id,user_id:a.user.user_id,given_result:a.given_result};d.post("api/v1/results",e).success(function(a){console.log(a)}),a.questionList&&Object.keys(a.questionList).length&&(a.questionList.list[a.index].mark_answer=1,sessionStorage.currentQuestionList=angular.toJson(a.questionList)),a.mark_answer(a.given_result)},a.save_answer=function(b){a.given_result=b,a.questionList&&Object.keys(a.questionList).length&&(a.questionList.list[a.index].given_result=b,sessionStorage.currentQuestionList=angular.toJson(a.questionList))},a.check_answer=function(b){a.checked_answer=b},a.correct_answer=function(){return a.question.correct_answer},a.mark_answer=function(b){a.mark_answer_free=!0;var c=a.question.type,d=a.correct_answer();c>1?(a.check_answer(b),b==d?(a.correctAnswer=b,a.answerButtonClass="btn-success"):(a.wrongAnswer=b,a.correctAnswer=d,a.answerButtonClass="btn-danger")):1==c&&(a.answerButtonClass="btn-info")},a.add_comment=function(){var b=new Date/1e3,c={comment:a.commentText,question_id:a.question_id,reply_to:0,username:a.user.username,date:b};d.post("api/v1/comments/"+a.user.user_id,c).success(function(b){c.voting=0,c.user_voting=0,c.comment_id=b.comment_id,a.question.comments.push(c),a.commentText=""})},a.delete_comment=function(b){var c=a.question.comments[b].comment_id;d["delete"]("api/v1/comments/"+c).success(function(){}),a.question.comments.splice(b,1)},a.increase_user_voting=function(b,c){var e=1==b?1:b+1,f={user_voting:e};return d.post("api/v1/comments/"+c+"/user/"+a.user.user_id,f).success(function(){}),e},a.decrease_user_voting=function(b,c){var e=-1==b?-1:b-1,f={user_voting:e};return d.post("api/v1/comments/"+c+"/user/"+a.user.user_id,f).success(function(){}),e},a.open_image_model=function(){f.open({templateUrl:"imageModalContent.html",controller:"ModalInstanceCtrl",resolve:{image_url:function(){return a.question.question_image_url}}})}}]).controller("ModalInstanceCtrl",["$scope","$modalInstance","image_url",function(a,b,c){a.image_url=c}]).controller("analysisCtrl",["$scope","Page","$http",function(a,b,c){b.set_title_and_nav("Analyse | Crucio","Lernen"),a.user=angular.fromJson(sessionStorage.user),a.questionList=angular.fromJson(sessionStorage.currentQuestionList);for(var d=0;d<a.questionList.list.length;d++){var e=a.questionList.list[d];if(!e.mark_answer){if(e.type>1&&e.given_result>0){var f=e.correct_answer==e.given_result?1:0;0==e.correct_answer&&(f=-1);var g={correct:f,question_id:e.question_id,user_id:a.user.user_id,given_answer:e.given_result};c.post("api/v1/results",g).success(function(){})}e.mark_answer="analysis"}}a.workedQuestionList=a.questionList.list.getArrayByKey("given_result"),a.exam_id=a.questionList.exam_id,a.all_question_count=a.questionList.list.length,a.worked_question_count=a.workedQuestionList.length,a.correct_q_count=0,a.wrong_q_count=0,a.seen_q_count=0,a.solved_q_count=0,a.free_q_count=0,a.no_answer_q_count=0,a.get_random=function(a,b){if(a>b)return-1;if(a==b)return a;var c;do c=Math.random();while(1==c);return a+parseInt(c*(b-a+1))},a.random=a.get_random(0,1e3);for(var d=0;d<a.worked_question_count;d++){var e=a.workedQuestionList[d];e.correct_answer==e.given_result&&e.given_result>0&&e.correct_answer>0&&a.correct_q_count++,e.correct_answer!=e.given_result&&e.given_result>0&&e.correct_answer>0&&a.wrong_q_count++,e.given_result>0&&a.solved_q_count++,e.given_result>-2&&a.seen_q_count++,1==e.type&&a.free_q_count++,0==e.correct_answer&&1!=e.type&&a.no_answer_q_count++}a.exam_id&&c.get("api/v1/exams/"+a.exam_id).success(function(b){a.exam=b})}]).controller("statisticsCtrl",["$scope","Page","$http",function(a,b){b.set_title_and_nav("Statistik | Crucio","Lernen"),a.user=angular.fromJson(sessionStorage.user)}]).filter("newline_to_br",["$sce",function(){return function(a){return void 0!==a?a.replace(/\n/g,"<br>"):void 0}}]).directive("timeago",function(){var a={prefixAgo:"vor",prefixFromNow:"in",suffixAgo:"",suffixFromNow:"",seconds:"wenigen Sekunden",minute:"etwa einer Minute",minutes:"%d Minuten",hour:"etwa einer Stunde",hours:"%d Stunden",day:"etwa einem Tag",days:"%d Tagen",month:"etwa einem Monat",months:"%d Monaten",year:"etwa einem Jahr",years:"%d Jahren",wordSeparator:" ",numbers:[]};return{restrict:"A",link:function(b,c,d){d.$observe("timeago",function(){function b(a){var b={};return a&&"[object Function]"===b.toString.call(a)}function e(c,d){var e=b(c)?c(d,h):c,f=a.numbers&&a.numbers[d]||d;return e.replace(/%d/i,f)}var f=parseInt(d.timeago),g=(new Date).getTime(),h=Math.abs(g-f),i=h/1e3,j=i/60,k=j/60,l=k/24,m=l/365,n=a.prefixAgo,o=a.suffixAgo,p=45>i&&e(a.seconds,Math.round(i))||90>i&&e(a.minute,1)||45>j&&e(a.minutes,Math.round(j))||90>j&&e(a.hour,1)||24>k&&e(a.hours,Math.round(k))||42>k&&e(a.day,1)||30>l&&e(a.days,Math.round(l))||45>l&&e(a.month,1)||365>l&&e(a.months,Math.round(l/30))||1.5>m&&e(a.year,1)||e(a.years,Math.round(m)),q=a.wordSeparator;String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};var r=[n,p,o].join(q).trim();c.text(r)})}}}),angular.module("userModule",["ipCookie"]).controller("registerCtrl",["$scope","Page","$route","$http","Validate",function(a,b,c,d,e){a.user=angular.fromJson(sessionStorage.user),a.is_working=0,a.semester=1,a.course=1,a.$watch("username",function(b,c){b!=c&&(a.error_no_name=!e.non_empty(b),a.error_duplicate_name=0)},!0),a.$watch("email",function(b,c){b!=c&&(a.error_no_email=!e.email(b),a.error_duplicate_email=0)},!0),a.$watch("password",function(b,c){b!=c&&(a.error_no_password=!e.password(b))},!0),a.register=function(){var b=1;if(a.username||(b=0,a.error_no_name=1),e.email(a.email)||(b=0,a.error_no_email=1),e.password(a.password)||(b=0,a.error_no_password=1),a.password!=a.passwordc&&(b=0),b){a.is_working=1;var c={username:a.username,email:a.email.replace("@","(@)"),semester:a.semester,course:a.course,password:a.password};d.post("api/v1/users",c).success(function(b){a.is_working=0,"success"==b.status?$("#registerSucessModal").modal("show"):"error_username_taken"==b.status?a.error_duplicate_name=1:"error_email_taken"==b.status&&(a.error_duplicate_email=1)})}}}]).controller("activateCtrl",["$scope","Page","$route","$http","$location",function(a,b,c,d,e){if(a.user=angular.fromJson(sessionStorage.user),a.token=e.search().token,a.token){var f={token:a.token};d.post("api/v1/users/action/activate",f).success(function(b){console.log(b),"error_unknown"==b.status?(a.success=0,a.error_no_token=0,a.error_unknown=1):"error_no_token"==b.status?(a.success=0,a.error_no_token=1,a.error_unknown=0):"success"==b.status&&(a.success=1,a.error_no_token=0,a.error_unknown=0)})}else a.success=0,a.error_no_token=1}]).controller("forgotPasswordCtrl",["$scope","$location","Page","$route","$http",function(a,b,c,d,e){if(a.user=angular.fromJson(sessionStorage.user),a.confirm=b.search().confirm,a.deny=b.search().deny,a.is_working=0,a.error_email=0,a.error_already_requested=0,a.confirm||a.deny||(a.reset=1),a.confirm){a.reset=0;var f={token:a.confirm};e.post("api/v1/users/password/confirm",f).success(function(b){a.status=b.status,$("#forgotConfirmModal").modal("show")})}if(a.deny){a.reset=0;var f={token:a.deny};e.post("api/v1/users/password/deny",f).success(function(b){a.status=b.status,$("#forgotDenyModal").modal("show")})}a.$watch("user.email",function(){a.error_email=0,a.error_already_requested=0},!0),a.reset_password=function(){
var b=!0;if(a.user?a.user.email||(b=!1,a.error_email=1):(b=!1,a.error_email=1),b){a.is_working=1;var c={email:a.user.email.replace("@","(@)")};e.post("api/v1/users/password/reset",c).success(function(b){a.is_working=0,b?"success"==b.status?(a.error_email=0,a.error_already_requested=0,$("#forgotSucessModal").modal("show")):"error_email"==b.status?a.error_email=1:"error_already_requested"==b.status&&(a.error_already_requested=1):a.error_email=1})}}}]).controller("loginCtrl",["$scope","Page","$route","$http","ipCookie",function(a,b,c,d,e){a.user=angular.fromJson(sessionStorage.user),a.email="",a.remember_me=1,a.password="",a.login_error=!1,a.$watch("email",function(){a.login_error=!1},!0),a.$watch("password",function(){a.login_error=!1},!0),a.login=function(){-1==a.email.indexOf("@")&&(a.email+="@studserv.uni-leipzig.de");var b={email:a.email.replace("@","(@)"),remember_me:a.remember_me,password:a.password};d.post("api/v1/users/action/login",b).success(function(b){"success"==b.login?(1==a.remember_me&&e("CrucioUserDev",b.logged_in_user,{expires:21}),sessionStorage.user=angular.toJson(b.logged_in_user),window.location.replace("/questions")):a.login_error=!0})}}]).controller("logoutCtrl",["$scope","Page","ipCookie",function(a,b,c){a.Page=b,a.user=angular.fromJson(sessionStorage.user),a.logout=function(){sessionStorage.user=angular.toJson({}),c.remove("CrucioUserDev"),window.location.replace(base_url)}}]).controller("accountCtrl",["$scope","Page","$http","Validate",function(a,b,c,d){b.set_title_and_nav("Account | Crucio","Name"),a.user=angular.fromJson(sessionStorage.user),a.user.semester=parseInt(a.user.semester),a.Validate=d,a.old_password="",a.wrong_password=!1,a.submit_button_title="Speichern",a.$watch("user.email",function(b,c){b!=c&&(a.submit_button_title="Speichern")},!0),a.$watch("old_password",function(b,c){b!=c&&(a.submit_button_title="Speichern",a.wrong_password=!1)},!0),a.$watch("new_password",function(b,c){b!=c&&(a.submit_button_title="Speichern")},!0),a.$watch("new_password_c",function(b,c){b!=c&&(a.submit_button_title="Speichern")},!0),a.save_user=function(){var b=!0;if(d.email(a.user.email)||(b=!1),(a.user.semester<1||a.user.semester>30)&&(b=!1),a.old_password.length>0&&(a.new_password.length<6&&(b=!1),a.new_password!=a.new_password_c&&(b=!1)),b){a.submit_button_title="Speichern...";var e={email:a.user.email.replace("@","(@)"),course_id:a.user.course_id,semester:a.user.semester,current_password:a.old_password,password:a.new_password};c.put("api/v1/users/"+a.user.user_id+"/account",e).success(function(b){console.log(b),"success"==b.status?(sessionStorage.user=angular.toJson(a.user),a.submit_button_title="Gespeichert"):(a.user=angular.fromJson(sessionStorage.user),a.user.semester=parseInt(a.user.semester),"error_incorrect_password"==b.status&&(a.wrong_password=!0),a.submit_button_title="Speichern nicht möglich...")})}else a.submit_button_title="Speichern nicht möglich..."}}]).controller("settingsCtrl",["$scope","Page","$http",function(a,b,c){b.set_title_and_nav("Einstellungen | Crucio","Name"),a.user=angular.fromJson(sessionStorage.user),$("#repetitionSlider").slider({value:a.user.repetitionValue}),a.submit_button_title="Speichern",a.update_user=function(){a.submit_button_title="Speichern...";var b=$("#repetitionSlider").slider("option","value");a.user.repetitionValue=b;var d={highlightExams:a.user.highlightExams,showComments:a.user.showComments,repetitionValue:b,useAnswers:a.user.useAnswers,useTags:a.user.useTags};c.put("api/v1/users/"+a.user.user_id+"/settings",d).success(function(b){"success"==b.status?(sessionStorage.user=angular.toJson(a.user),a.submit_button_title="Gespeichert"):(a.user=angular.fromJson(sessionStorage.user),a.submit_button_title="Speichern nicht möglich...")})},a.remove_all_results=function(){var b={};c["delete"]("api/v1/results/"+a.user.user_id,b).success(function(){})}}]).service("Validate",["$http",function(a){var b=Array();a.get("api/v1/whitelist").success(function(a){b=a.whitelist}),this.email=function(a){var c=/[\wäüöÄÜÖ]*@studserv\.uni-leipzig\.de$/;if(0==b.length)return!0;if(c.test(a))return!0;for(var d=0;d<b.length;d++)if(b[d].mail_address==a)return!0;return!1},this.password=function(a){return a?a.length<6?!1:!0:!1},this.non_empty=function(a){return 0==a.length?!1:!0}}]);